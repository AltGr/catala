\documentclass[11pt,a4paper]{article}

\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{fullpage}
\usepackage{lmodern}
\usepackage{amsmath,amssymb}
\usepackage{mathpartir}
\usepackage{xcolor}
\usepackage{booktabs}
\usepackage{nicefrac}

\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}

%% Syntax
\newcommand{\synvar}[1]{\ensuremath{#1}}
\newcommand{\synkeyword}[1]{\textcolor{red!60!black}{\texttt{#1}}}
\newcommand{\synpunct}[1]{\textcolor{black!40!white}{\texttt{#1}}}
\newcommand{\synname}[1]{\ensuremath{\mathsf{#1}}}

\newcommand{\synbool}{\synkeyword{bool}}
\newcommand{\synnum}{\synkeyword{num}}
\newcommand{\syndate}{\synkeyword{date}}
\newcommand{\synvec}{\synkeyword{vec~}}
\newcommand{\synopt}{\synkeyword{opt~}}

\newcommand{\syncase}{\synkeyword{case~}}
\newcommand{\synof}{\synkeyword{~of~}}
\newcommand{\synif}{\synkeyword{if~}}
\newcommand{\synthen}{\synkeyword{~then~}}
\newcommand{\synelse}{\synkeyword{~else~}}
\newcommand{\synlet}{\synkeyword{let~}}
\newcommand{\synin}{\synkeyword{~in~}}
\newcommand{\synequal}{\synkeyword{~=~}}
\newcommand{\syntrue}{\synkeyword{true}}
\newcommand{\synfalse}{\synkeyword{false}}
\newcommand{\syninj}[1]{\synkeyword{inj}\synvar{_{#1}}\;}
\newcommand{\synpi}[1]{\synvar{\Pi}$_{#1}$\;}
\newcommand{\synLambda}{\synvar{\Lambda}}
\newcommand{\syntypforall}{\synvar{\forall}}
\newcommand{\synop}{\synvar{\odot}}
\newcommand{\synand}{\synvar{\wedge}}
\newcommand{\synor}{\synvar{\vee}}
\newcommand{\synemptydefault}{\synvar{\varnothing}}
\newcommand{\synmerge}{\synkeyword{~++~}}

\newcommand{\synvardef}{\synkeyword{definition~}}
\newcommand{\synscopecall}{\synkeyword{scope\_call~}}

\newcommand{\syntyparrow}{\synvar{\rightarrow}}
\newcommand{\syntypsum}{\synvar{+}}
\newcommand{\syntypproduct}{\synvar{\times}}
\newcommand{\syndiamond}{\;\synvar{\diamond}\;}
\newcommand{\synerror}{\synvar{\circledast}}
\newcommand{\syndot}{.\;}

\newcommand{\syndef}{$ ::= $}
\newcommand{\synalt}{\;$|$\;}
\newcommand{\syncolon}{\;:\;}

\newcommand{\synlambda}[3]{\ensuremath{\lambda#1:#2.\;#3}}
\newcommand{\syncaseof}[3]{\syncase\synvar{#1}\synof\synvar{#2}\syndiamond\synvar{#3}}
\newcommand{\synscope}[2]{\synvar{(#1:#2)}}
\newcommand{\syndefault}[3]{\left[\nicefrac{\synvar{#1_1}}{\synvar{#2_1}},\;\ldots,\;\nicefrac{\synvar{#1_#3}}{\synvar{#2_#3}};\prec\right]}
\newcommand{\synhole}{\synvar{\cdot}}

%% Typing
\newcommand{\typctx}[1]{\textcolor{orange!90!black}{\ensuremath{#1}}}

\newcommand{\typempty}{\typctx{\varnothing}}
\newcommand{\typcomma}{\typctx{,\;}}
\newcommand{\typvdash}{\typctx{\;\vdash\;}}
\newcommand{\typcolon}{\typctx{\;:\;}}
\newcommand{\typlpar}{\typctx{(}}
\newcommand{\typrpar}{\typctx{)}}

%% Well-formedness
\newcommand{\wfctx}[1]{\textcolor{green!50!black}{\ensuremath{#1}}}
\newcommand{\wfkeyword}[1]{\textcolor{green!50!black}{\texttt{#1}}}

\newcommand{\wfgammaempty}{\wfctx{\varnothing_\Gamma}}
\newcommand{\wfdeltaempty}{\wfctx{\varnothing_\Delta}}
\newcommand{\wfcomma}{\wfctx{,}\;}
\newcommand{\wfok}{\wfkeyword{~ok}}
\newcommand{\wfokin}{\wfkeyword{~ok~in~}}
\newcommand{\wfArrow}{\wfctx{~\Rightarrow~}}
\newcommand{\wfarrow}{\wfctx{~\rightarrow~}}
\newcommand{\wfeq}{\;\wfctx{=}\;}
\newcommand{\wfvdash}{\;\wfctx{\vdash}\;}
\newcommand{\wfsemicolon}{\wfctx{;\;}}

%% Evaluation and execution
\newcommand{\exctx}[1]{\textcolor{blue!80!black}{\ensuremath{#1}}}

\newcommand{\Omegaarg}{\Omega_{arg}}
\newcommand{\excaller}{\exctx{\complement}}
\newcommand{\excomma}{\exctx{,}\;}
\newcommand{\exvdash}{\;\exctx{\vdash}\;}
\newcommand{\exempty}{\exctx{\varnothing}}
\newcommand{\exemptyv}{\exctx{\varnothing_v}}
\newcommand{\exemptyarg}{\exctx{\varnothing_{arg}}}
\newcommand{\exvarmap}{\exctx{~\mapsto~}}
\newcommand{\exscopemap}{\exctx{~\rightarrowtail~}}
\newcommand{\exArrow}{\exctx{~\Rrightarrow~}}
\newcommand{\exeq}{\exctx{\;=\;}}
\newcommand{\exeval}{\exctx{\;\longrightarrow\;}}
\newcommand{\exevalstar}{\exctx{\;\longrightarrow^*\;}}
\newcommand{\exat}{\exctx{\texttt{\;@\;}}}
\newcommand{\exsemicolon}{\exctx{;~}}
\newcommand{\excomp}{\dashrightarrow}

\newcommand{\exrewrite}[2]{\left\langle#2\right\rangle_{#1}}
\newcommand{\exmerge}{\exctx{\mu}}
\newcommand{\exmergeback}[2]{\exctx{\mu^{-1}(}#1\exsemicolon#2\exctx{)}}

\title{Catala formalization}
\date{}
\author{Nicolas Chataing}

\begin{document}
\maketitle

\section{Default calculus}

\subsection{Syntax}

\begin{figure}[h]
\centering
\fbox{\begin{tabular}{lrrll}
  Type&\synvar{\tau}&\syndef&\synbool&boolean type\\
  &&\synalt&\synvar{\tau}\;\syntyparrow\;\synvar{\tau}&function type \\
  &&&&\\
  Expression&\synvar{e}&\syndef&\synvar{x}\synalt\synlambda{x}{\tau}{e}\synalt\synvar{e}\;\synvar{e}&$\lambda$-calculus\\
  &&\synalt&\synvar{D}&default term\\
  &&&&\\
  Default&\synvar{D}&\syndef&$\{\nicefrac{\synvar{e}}{\synvar{e}}, [\synvar{D}^*]\}$&default term\\
  &&\synalt&\synerror&conflict error term\\
  &&\synalt&\synemptydefault&empty error term\\
\end{tabular}}
\caption{Syntax of the default calculus}
\end{figure}

\subsection{Typing}

\begin{center}
  \begin{tabular}{lrr}
    \typctx{\Gamma}&\syndef&\typempty\synalt\typctx{\Gamma}\typcomma\synvar{\alpha}\synalt\typctx{\Gamma}\typcomma\synvar{x}\typcolon\synvar{\sigma}
  \end{tabular}
\end{center}

Typing judgments : $\typctx{\Gamma}\typvdash\synvar{e}\typcolon\synvar{\tau}$.

\begin{figure}
\centering
\fbox{\begin{mathpar}
  \inferrule[Var]{ }{\typctx{\Gamma}\typcomma\synvar{x}\syncolon\synvar{\sigma}\typvdash\synvar{x}\syncolon\synvar{\sigma}}

  \inferrule[Abs]
  {\typctx{\Gamma}\typcomma\synvar{x}\typcolon\synvar{\tau}\typvdash\synvar{e}\typcolon\synvar{\tau'}}
  {\typctx{\Gamma}\typvdash\synlambda{x}{\tau}{e}\typcolon\synvar{\tau}\syntyparrow\synvar{\tau'}}

  \inferrule[App]
  {
    \typctx{\Gamma}\typvdash\synvar{e_1}\typcolon\synvar{\tau_2}\syntyparrow\synvar{\tau_1}\\
    \typctx{\Gamma}\typvdash\synvar{e_2}\typcolon\synvar{\tau_2}
  }
  {\typctx{\Gamma}\typvdash\synvar{e_1}\;\synvar{e_2}\typcolon\synvar{\tau_1}}
  
  \inferrule[DefaultBase]
  {
    \typctx{\Gamma}\typvdash\synvar{b}\typcolon\synbool\\
    \typctx{\Gamma}\typvdash\synvar{e}\typcolon\synvar{\tau}\\
    \typctx{\Gamma}\typvdash\synvar{D_i}\typcolon{\tau}
  }
  {\typctx{\Gamma}\typvdash\{\nicefrac{\synvar{b}}{\synvar{e}},[\synvar{D_1},\ldots,\synvar{D_n}]\}\typcolon\synvar{\tau}}

  \inferrule[DefaultFun]
  {
    \typctx{\Gamma}\typcomma\synvar{x}\typcolon\synvar{\tau}\typvdash\{\nicefrac{\synvar{b}}{\synvar{e}} ,[]\}\typcolon\synvar{\tau'}\\
    \typctx{\Gamma}\typvdash\synvar{D_i}\typcolon\synvar{\tau}\syntyparrow\synvar{\tau'}
  }
  {\typctx{\Gamma}\typvdash\{\nicefrac{\synlambda{\synvar{x}}{\synvar{\tau}}{\synvar{b}}}{\synlambda{\synvar{x}}{\synvar{\tau}}{\synvar{e}}}, [\synvar{D_1},\ldots,\synvar{D_n}]\}\typcolon\tau\syntyparrow\tau'}

  \inferrule[ConflictError]{}{\typctx{\Gamma}\typvdash\synerror\typcolon\synvar{\tau}}

  \inferrule[EmptyError]{}{\typctx{\Gamma}\typvdash\synemptydefault\typcolon\synvar{\tau}}

\end{mathpar}}
\caption{Default calculus typing rules}
  \label{fig:typing}
\end{figure}

\subsection{Evaluation}

\newcommand{\exDeval}{\exctx{\;\Downarrow\;}}
\newcommand{\exnotDeval}{\exctx{\;\nRightarrow\;}}

$$ A([D_1, \ldots, D_n]) = \#\{i | D_i \exnotDeval \synemptydefault \} $$
$$ B([D_1, \ldots, D_n]) = e~|~D_i \exDeval e \wedge e \neq \synemptydefault $$

\begin{figure}
\centering
\fbox{\begin{mathpar}
  \inferrule[JustifTrue]
  {\synvar{b}\exevalstar\top}
  {\{\nicefrac{\synvar{b}}{\synvar{e}},[\synvar{D_1}, \ldots, \synvar{D_n}]\}\exDeval e}

  \inferrule[NoJustifTrue]
  {\synvar{b}\exevalstar\bot\\A([D_1, \ldots, D_n]) = 0}
  {\{\nicefrac{\synvar{b}}{\synvar{e}},[\synvar{D_1}, \ldots, \synvar{D_n}]\}\exDeval\synemptydefault}

  \inferrule[DefaultOk]
  {\synvar{b}\exevalstar\bot\\A([D_1, \ldots, D_n]) = 1\\B([D_1, \ldots, D_n]) = \synvar{e}}
  {\{\nicefrac{\synvar{b}}{\synvar{e}},[\synvar{D_1}, \ldots, \synvar{D_n}]\}\exDeval\synvar{e}}
  
  \inferrule[DefaultConflict]
  {\synvar{b}\exevalstar\bot\\A([D_1, \ldots, D_n]) > 1}
  {\{\nicefrac{\synvar{b}}{\synvar{e}},[\synvar{D_1}, \ldots, \synvar{D_n}]\}\exDeval\synerror}

\end{mathpar}}
  \caption{Default evaluation}
\end{figure}

\begin{center}
  \begin{tabular}{rcll}
    \synvar{v}&\syndef&\synlambda{i}{\tau}{e}&functions\\
    \synvar{C}&\syndef&\synhole\;\synvar{e}\synalt\synvar{v}\;\synhole&
  \end{tabular}
\end{center}

\begin{figure}
  \centering\fbox{
\begin{mathpar}
  \inferrule[$\beta_v$]{}{(\synlambda{x}{\tau}{e})\;\synvar{v}\exeval[\synvar{x}\mapsto\synvar{v}]e}

  \inferrule[$\beta_d$]{}{\{\nicefrac{\synvar{b}}{\synvar{e}},[D_1,\ldots,D_n]\}~v\exeval\{\nicefrac{\synvar{b}\;\synvar{v}}{\synvar{e}\;\synvar{v}},[\synvar{D_1}\;\synvar{v},\ldots,\synvar{D_n}\;\synvar{v}]\}}

  \inferrule[Context]
  {\synvar{e}\exeval\synvar{e'}}
  {\synvar{C}[\synvar{e}]\exeval\synvar{C}[\synvar{e'}]}

  \inferrule[Default]
  {\synvar{D}\exDeval\synvar{e}}
  {\synvar{D}\exeval\synvar{e}}
  
  \inferrule[ConflictError]
  {e\exeval\synerror}
  {C[e]\exeval\synerror}

  \inferrule[EmptyError]
  {e\exeval\synemptydefault}
  {C[e]\exeval\synemptydefault}
\end{mathpar}
}
\caption{Default calculus evaluation}
\end{figure}

\end{document}
